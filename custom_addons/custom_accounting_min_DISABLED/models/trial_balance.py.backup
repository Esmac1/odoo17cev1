# -*- coding: utf-8 -*-
from odoo import models, fields, api, _
from odoo.exceptions import UserError
from datetime import date
import io
import base64

class TrialBalanceWizard(models.TransientModel):
    _name = 'custom_accounting.trial.balance.wizard'
    _description = 'Trial Balance Report Wizard'
    
    date_from = fields.Date(string='From Date', required=True, default=lambda self: fields.Date.today().replace(day=1))
    date_to = fields.Date(string='To Date', required=True, default=fields.Date.today)
    target_move = fields.Selection([
        ('posted', 'All Posted Entries'),
        ('all', 'All Entries')
    ], string='Target Moves', required=True, default='posted')
    
    # Results fields
    result_html = fields.Html(string='Result', compute='_compute_result', sanitize=False)
    excel_file = fields.Binary(string='Excel File', compute='_compute_excel_file')
    excel_filename = fields.Char(string='Filename', compute='_compute_excel_filename')
    
    @api.depends('date_from', 'date_to', 'target_move')
    def _compute_result(self):
        for wizard in self:
            lines = self._get_trial_balance_lines()
            
            # Calculate totals
            total_debit = sum(line['debit'] for line in lines)
            total_credit = sum(line['credit'] for line in lines)
            total_balance = sum(line['balance'] for line in lines)
            
            # Generate HTML table
            html = '''
            <div class="trial-balance-report">
                <h3>Trial Balance Report</h3>
                <p>Period: %s to %s</p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Account Code</th>
                            <th>Account Name</th>
                            <th>Type</th>
                            <th>Opening Balance</th>
                            <th>Debit</th>
                            <th>Credit</th>
                            <th>Closing Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            ''' % (wizard.date_from, wizard.date_to)
            
            for line in lines:
                html += '''
                    <tr>
                        <td>%s</td>
                        <td>%s</td>
                        <td>%s</td>
                        <td style="text-align: right">%s</td>
                        <td style="text-align: right">%s</td>
                        <td style="text-align: right">%s</td>
                        <td style="text-align: right">%s</td>
                    </tr>
                ''' % (
                    line['code'] or '',
                    line['name'] or '',
                    line['type'] or '',
                    '{:,.2f}'.format(line['opening']),
                    '{:,.2f}'.format(line['debit']),
                    '{:,.2f}'.format(line['credit']),
                    '{:,.2f}'.format(line['balance'])
                )
            
            html += '''
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold;">
                            <td colspan="4">Totals</td>
                            <td style="text-align: right">%s</td>
                            <td style="text-align: right">%s</td>
                            <td style="text-align: right">%s</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            ''' % (
                '{:,.2f}'.format(total_debit),
                '{:,.2f}'.format(total_credit),
                '{:,.2f}'.format(total_balance)
            )
            
            wizard.result_html = html
    
    def _get_trial_balance_lines(self):
        self.ensure_one()
        
        # Domain for moves
        domain = [
            ('date', '>=', self.date_from),
            ('date', '<=', self.date_to)
        ]
        
        if self.target_move == 'posted':
            domain.append(('state', '=', 'posted'))
        
        # Get all posted moves in period
        moves = self.env['custom_accounting.move'].search(domain)
        move_lines = self.env['custom_accounting.move.line'].search([
            ('move_id', 'in', moves.ids)
        ])
        
        # Get all accounts
        accounts = self.env['custom_accounting.account'].search([])
        
        results = []
        
        for account in accounts:
            # Opening balance (before date_from)
            opening_domain = [
                ('account_id', '=', account.id),
                ('date', '<', self.date_from),
                ('move_id.state', '=', 'posted')
            ]
            opening_lines = self.env['custom_accounting.move.line'].search(opening_domain)
            opening_balance = sum(line.balance for line in opening_lines)
            
            # Period activity
            period_domain = [
                ('account_id', '=', account.id),
                ('date', '>=', self.date_from),
                ('date', '<=', self.date_to)
            ]
            if self.target_move == 'posted':
                period_domain.append(('move_id.state', '=', 'posted'))
            
            period_lines = self.env['custom_accounting.move.line'].search(period_domain)
            
            period_debit = sum(line.debit for line in period_lines)
            period_credit = sum(line.credit for line in period_lines)
            period_balance = sum(line.balance for line in period_lines)
            
            # Closing balance
            closing_balance = opening_balance + period_balance
            
            # Only include accounts with activity
            if opening_balance != 0 or period_debit != 0 or period_credit != 0:
                results.append({
                    'code': account.code,
                    'name': account.name,
                    'type': account.type,
                    'opening': opening_balance,
                    'debit': period_debit,
                    'credit': period_credit,
                    'balance': closing_balance,
                })
        
        # Sort by account code
        results.sort(key=lambda x: x['code'] or '')
        
        return results
    
    def _compute_excel_file(self):
        for wizard in self:
            import xlsxwriter
            
            output = io.BytesIO()
            workbook = xlsxwriter.Workbook(output, {'in_memory': True})
            worksheet = workbook.add_worksheet('Trial Balance')
            
            # Formats
            header_format = workbook.add_format({
                'bold': True,
                'align': 'center',
                'valign': 'vcenter',
                'bg_color': '#366092',
                'font_color': 'white',
                'border': 1
            })
            
            currency_format = workbook.add_format({
                'num_format': '#,##0.00',
                'border': 1
            })
            
            # Write headers
            headers = ['Account Code', 'Account Name', 'Type', 'Opening Balance', 'Debit', 'Credit', 'Closing Balance']
            for col, header in enumerate(headers):
                worksheet.write(0, col, header, header_format)
            
            # Get data
            lines = wizard._get_trial_balance_lines()
            
            # Write data
            for row, line in enumerate(lines, start=1):
                worksheet.write(row, 0, line['code'] or '')
                worksheet.write(row, 1, line['name'] or '')
                worksheet.write(row, 2, line['type'] or '')
                worksheet.write(row, 3, line['opening'], currency_format)
                worksheet.write(row, 4, line['debit'], currency_format)
                worksheet.write(row, 5, line['credit'], currency_format)
                worksheet.write(row, 6, line['balance'], currency_format)
            
            # Auto-fit columns
            for col in range(len(headers)):
                worksheet.set_column(col, col, 15)
            
            workbook.close()
            output.seek(0)
            
            wizard.excel_file = base64.b64encode(output.read())
    
    def _compute_excel_filename(self):
        for wizard in self:
            wizard.excel_filename = 'trial_balance_%s_%s.xlsx' % (
                wizard.date_from.strftime('%Y%m%d') if wizard.date_from else '',
                wizard.date_to.strftime('%Y%m%d') if wizard.date_to else ''
            )
    
    def print_report(self):
        return {
            'type': 'ir.actions.act_url',
            'url': '/web/content/?model=custom_accounting.trial.balance.wizard&id=%s&field=excel_file&filename_field=excel_filename&download=true' % self.id,
            'target': 'self',
        }
